name: Docker Dependency Refresh

on:
  schedule:
    - cron: '0 6 1 * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Parse Dockerfile dependency args
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          dockerfile = Path("Dockerfile").read_text(encoding="utf-8")

          node_major = re.search(r"^ARG\s+NODEJS_MAJOR=([^\s]+)$", dockerfile, re.MULTILINE)
          mermaid = re.search(r"^ARG\s+MERMAID_CLI_VERSION=([^\s]+)$", dockerfile, re.MULTILINE)

          if not node_major or not mermaid:
              raise SystemExit("Could not parse required Dockerfile args (NODEJS_MAJOR / MERMAID_CLI_VERSION)")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              out.write(f"node_major={node_major.group(1)}\n")
              out.write(f"mermaid_current={mermaid.group(1)}\n")
          PY

      - name: Resolve latest dependency versions
        id: latest
        shell: bash
        run: |
          set -euo pipefail

          MERMAID_LATEST=$(docker run --rm node:22-alpine sh -lc "npm view @mermaid-js/mermaid-cli version")

          echo "mermaid_latest=${MERMAID_LATEST}" >> "${GITHUB_OUTPUT}"

      - name: Update Dockerfile when drift detected
        id: update
        shell: bash
        env:
          MERMAID_CURRENT: ${{ steps.parse.outputs.mermaid_current }}
          MERMAID_LATEST: ${{ steps.latest.outputs.mermaid_latest }}
        run: |
          set -euo pipefail

          if [ "${MERMAID_CURRENT}" = "${MERMAID_LATEST}" ]; then
            echo "needs_update=false" >> "${GITHUB_OUTPUT}"
            echo "No dependency drift detected."
            exit 0
          fi

          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path("Dockerfile")
          content = path.read_text(encoding="utf-8")

          updated = re.sub(
              r"^ARG\s+MERMAID_CLI_VERSION=.*$",
              f"ARG MERMAID_CLI_VERSION={os.environ['MERMAID_LATEST']}",
              content,
              flags=re.MULTILINE,
          )

          if updated == content:
              raise SystemExit("Failed to update MERMAID_CLI_VERSION in Dockerfile")

          path.write_text(updated, encoding="utf-8")
          PY

          echo "needs_update=true" >> "${GITHUB_OUTPUT}"

      - name: Create pull request for dependency refresh
        if: steps.update.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(docker): refresh mermaid-cli pin"
          branch: "chore/docker-dependency-refresh"
          delete-branch: true
          title: "chore(docker): refresh mermaid-cli pin"
          body: |
            Automated Docker dependency refresh.

            - `MERMAID_CLI_VERSION`: `${{ steps.parse.outputs.mermaid_current }}` â†’ `${{ steps.latest.outputs.mermaid_latest }}`
            - `NODEJS_MAJOR`: `${{ steps.parse.outputs.node_major }}` (tracked major channel)

            Notes:
            - Ubuntu APT packages are intentionally unpinned in `Dockerfile` to receive security updates during regular rebuilds.
            - Base images remain digest-pinned for supply-chain integrity.
            - This PR updates only intentional app-level pinning.

      - name: Job summary
        shell: bash
        run: |
          echo "## Docker dependency refresh" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Node major: \`${{ steps.parse.outputs.node_major }}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Mermaid current: \`${{ steps.parse.outputs.mermaid_current }}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Mermaid latest: \`${{ steps.latest.outputs.mermaid_latest }}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Update required: \`${{ steps.update.outputs.needs_update || 'false' }}\`" >> "${GITHUB_STEP_SUMMARY}"
